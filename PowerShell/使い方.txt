■バッチについて
サクラエディタ使用者が、複数回連続でGrep実行を行うためのバッチです。
業務でExcelで検索条件をまとめて、それをコピペして実行するという運用想定です。
検索、置換に対応しています。

また、実行結果に対する分析等を行うために、結果をExcelに張り付けすることも想定されています。
その関係で、検索結果に対しタブが半角スペースに変換する加工がなされています。ご了承ください。

本バッチはPowerShellを用いていますが、バッチ起動は通常のコマンドから行うように作られています。


■文字化けに関する注意
日本語を多用しているため、ps1ファイルの保存形式はShift-JIS、またはBOM付きのUTF-8で保存してください。
普通のUTF-8を使用した場合、コマンド実行時に文字化けすることがあります。
※PowerShellの標準設定がshift-jisのため、実行時に文字化けします。これは端末のPowerShellの設定により変わる場合もあります。


■前準備１：共通設定
「config.ps1」をサクラエディタで開き、以下の設定を変更してください。
targetDir               ：Grepフォルダパスを設定します。
isTargetDirRelationPath ：targetDirを相対パスで指定する場合は1を設定します。
grepMode                ：Grepの検索のみを行いたい場合はS、置換を行いたい場合はRを設定します。
baseFileExtention       ：Grepしたい拡張子を設定します。
isOutLogTsv             ：通常のサクラエディタのログを出力したい場合は0を設定します。
baseGrepOption          ：サクラエディタのGrepオプションです。正規表現しか使わない場合、Rを追加してください。（補足１）

上記以外の設定は、「config.ps1」内の説明より任意に変更してください。


■前準備２：Grep一覧の準備
「Grep一覧.xlsx」に、検索条件や置換文字列を入力してください。
No           ：管理番号など、任意の文字を入力してください（文字列可、重複可）
フォルダ指定 ：共通設定で指定したGrepフォルダパスにこの内容を追記します。（先頭の\は不要）
ファイル指定 ：共通設定で指定した拡張子を無視して、この内容がGrep時のファイル設定に使用されます。
検索設定     ：サクラエディタのコマンドライン実行時の検索オプションです。（補足１、２）
検索文字列   ：検索文字列です。正規表現使用時は、検索設定にRを含めてください。
置換文字列   ：置換文字列です。

「Grep一覧.xlsx」に検索条件をまとめ終わったら、
その内容（No〜置換文字列までのセル、ヘッダーを含まない）をコピーしてください。
コピーした内容を、「keywords.tsv」に張り付けしてください。

これで準備が完了です。


■バッチの実行
「SakuraGrepBatch.bat」をダブルクリックで実行してください。
実行すると、実行フォルダに「logs」フォルダが作成されます。
その中に「greplog_[タイムスタンプ].tsv」形式のファイルが出力されます。
このファイルの内容をコピーし、「Grep結果.xlsx」に張り付けてください。

※標準のサクラエディタの結果を出力する設定の場合、拡張子が「.log」で出力されます。


■補足１：サクラエディタのコマンドラインオプション
詳細はhttps://sakura-editor.github.io/help/HLP000109.html参照
S : サブフォルダーからも検索
L : 大文字と小文字を区別
R : 正規表現
P : 該当行を出力／未指定時は該当部分だけ出力
W : 単語単位で探す
1|2|3 : 結果出力形式。1か2か3のどれかを指定します。(1=ノーマル、2=ファイル毎、3=結果のみ)
K : -GCODE=99と同じ意味です。互換性のためだけに残されています。
F : ファイル毎最初のみ(検索のみ)
B : ベースフォルダー表示
G : フォルダー毎に表示
X : Grep実行後カレントディレクトリを移動しない
C : (置換)クリップボードから貼り付け (sakura:2.2.0.0以降)
O : (置換)バックアップ作成 (sakura:2.2.0.0以降)
U : 標準出力に出力し、Grep画面にデータを表示しない コマンドラインからパイプやリダイレクトを指定することで結果を利用できます。(sakura:2.2.0.0以降)
H : ヘッダー・フッターを出力しない(sakura:2.2.0.0以降)

以下は「config.ps1」の詳細設定で設定しています（変更可）
SL

以下はシステムで強制的に設定されます。（変更不可）
1XPU
H（tsv形式で整形した結果を出力する場合）


■補足２：Grep実行時の検索設定
検索設定の追加はできますが、検索設定の解除はできません。
例
ほとんど正規表現だからbaseGrepOptionにRを追加した。
後になって1〜2件だけ正規表現のエスケープが面倒になったので、部分的に正規表現を使わないようにしたい。
こうした場合に検索設定に「-R」を入れたら解除、みたいにできたら楽ですが、そういった機能はありません。
